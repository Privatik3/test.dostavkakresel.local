$.ui.fancytree._FancytreeNodeClass.prototype.getParentByKey=function(b){b=null==b?null:""+b;var c=this;if(null!=b&&b!==this.key)for(;c.key.indexOf(b)&&!c.isRootNode();)c=c.getParent();return c.isRootNode()?null:c};$.ui.fancytree._FancytreeNodeClass.prototype.findUnselectedSibling=function(){for(var b=this.getNextSibling()||this.getPrevSibling()||this.getParent();b.isSelected()&&!b.isRootNode();)b=b.getPrevSibling()||b.getParent();return b};
function reactivateCategory(b){$category_tree.each(function(c,a){var d=$("#"+a.id).fancytree("getTree");(d=d.getNodeByKey(b.key)||d.getActiveNode())&&void 0!==d&&(d.setActive(!1),d.setActive(!0))})}
function reloadAttribute(){if(0==arguments.length)$attribute_trees.each(function(a,b){var c=$("#"+b.id).fancytree("getTree");ClearFilter(c);c.reload().done(function(){c.options.source.data.isPending=!1})});else{var b=arguments[0],c=arguments[1];$attribute_trees.each(function(a,d){var f=$("#"+d.id).fancytree("getTree");if(f!==b.tree||c)ClearFilter(f),f.reload().done(function(){f.options.source.data.isPending=!1;var a=f.getNodeByKey(b.key);a&&void 0!==a&&a.setActive()})});c||b.setActive();reactivateCategory(b)}}
function ClearFilter(b,c,a){b.isFilterActive()&&(b.clearFilter(),3===arguments.length?($("input[name *= "+c+"_search"+a+"]").val(""),$("span[id *= "+c+"_matches"+a+"]").text("")):($('input[name *= "search"]').val(""),$('span[id *= "matches"]').text("")),$("[id ^=loadImg]").hide())}
function FilterSettingsChange(b){var c=$(this).attr("id"),a=$(this).is(":checked");switch(c){case b.data.tab+"_autoComplete"+b.data.lng_id:$("button#"+b.data.tab+"_btnSearch"+b.data.lng_id).attr("disabled",$(this).is(":checked"));break;case b.data.tab+"_hideMode"+b.data.lng_id:b.data.tree.options.filter.mode=a?"hide":"dimm";break;case b.data.tab+"_counter"+b.data.lng_id:case b.data.tab+"_fuzzy"+b.data.lng_id:case b.data.tab+"_hideExpandedCounter"+b.data.lng_id:case b.data.tab+"_highlight"+b.data.lng_id:b.data.tree.options.filter[c.replace(/\d/g,
"")]=a}b.data.tree.clearFilter();$("input[name="+b.data.tab+"_search"+b.data.lng_id+"]").trigger("keyup")}
function FilterSearch(b){var c=0,a={autoExpand:$("#"+b.data.tab+"_autoExpand"+b.data.lng_id).is(":checked"),leavesOnly:$("#"+b.data.tab+"_leavesOnly"+b.data.lng_id).is(":checked")},d=$("#"+b.data.tab+"_attributesOnly"+b.data.lng_id).is(":checked"),f=$(this).val();b&&b.which===$.ui.keyCode.ESCAPE||""===$.trim(f)?$("button#"+b.data.tab+"_btnResetSearch"+b.data.lng_id).click():($("#"+b.data.tab+"_autoComplete"+b.data.lng_id).is(":checked")&&(d||b.data.tree.options.source.data.isPending||(b.data.tree.visit(function(a){a.isLazy()&&
a.load(!0)}),b.data.tree.options.source.data.isPending=!0),setTimeout(function(){c=$("#"+b.data.tab+"_regex"+b.data.lng_id).is(":checked")?b.data.tree.filterNodes(function(a){return(new RegExp(f,"i")).test(a.title)},a):b.data.tree.filterNodes(f,a);$("span#"+b.data.tab+"_matches"+b.data.lng_id).text("("+c+")")},600)),$("button#"+b.data.tab+"_btnResetSearch"+b.data.lng_id).attr("disabled",!1),$("span#"+b.data.tab+"_matches"+b.data.lng_id).text("("+c+")"))}
function FilterButtonSearch(b){var c=0,a={autoExpand:$("#"+b.data.tab+"_autoExpand"+b.data.lng_id).is(":checked"),leavesOnly:$("#"+b.data.tab+"_leavesOnly"+b.data.lng_id).is(":checked")},d=$("#"+b.data.tab+"_attributesOnly"+b.data.lng_id).is(":checked"),f=$("input[name="+b.data.tab+"_search"+b.data.lng_id+"]").val();b&&b.which===$.ui.keyCode.ESCAPE||""===$.trim(f)?$("button#"+b.data.tab+"_btnResetSearch"+b.data.lng_id).click():(d||b.data.tree.options.source.data.isPending||(b.data.tree.visit(function(a){a.isLazy()&&
a.load(!0)}),b.data.tree.options.source.data.isPending=!0),setTimeout(function(){c=$("#"+b.data.tab+"_regex"+b.data.lng_id).is(":checked")?b.data.tree.filterNodes(function(a){return(new RegExp(f,"i")).test(a.title)},a):b.data.tree.filterNodes(f,a);$("span#"+b.data.tab+"_matches"+b.data.lng_id).text("("+c+")")},600),$("button#"+b.data.tab+"_btnResetSearch"+b.data.lng_id).attr("disabled",!1),$("span#"+b.data.tab+"_matches"+b.data.lng_id).text("("+c+")"))}
function getSelectedKeys(b){var c=[];b&&b.forEach(function(a){c.push(a.key)});return c}function getSelectedTitles(){var b=[];selNodes&&selNodes.forEach(function(c){b.push(c.title)});return b}function deSelectNodes(b){selNodes&&selNodes.forEach(function(b){b.setSelected(!1)});selNodes=null}function selectControl(b){if(b.node.isTopLevel())return b.node.setSelected(!1),!1;b.node.tree.visit(function(c){b.node.getLevel()!==c.getLevel()&&c.setSelected(!1)});return!0}
function addAttribute(b,c,a){var d=b;for(b="attribute"===c?2:1;d.getLevel()>b;)d=d.getParent();$.ajax({data:{token:token,key:d.key,name:"attribute"===c?textNewAttribute:textNewGroup},url:"index.php?route="+extension+"module/attributico/addAttribute",success:function(b){d.editCreateNode("child",{title:"attribute"===c?textNewAttribute[a]:textNewGroup[a],key:c+"_"+b,folder:"group"===c?!0:!1})}})}
function deleteAttribute(b){if(2===b.getLevel()||3===b.getLevel()){var c=b.findUnselectedSibling();$.ajax({data:{token:token,keys:selNodes?getSelectedKeys(selNodes):[b.key]},url:"index.php?route="+extension+"module/attributico/deleteAttributes",success:function(){selNodes?$.each(selNodes,function(a,b){b.remove()}):b.remove();reloadAttribute(c,!1);selNodes=null}})}}
function copyAttributes(b){var c=b.getParentByKey("group")||b.getParentByKey("category");c.key.indexOf("group")+1&&$.ajax({data:{token:token,target:c.key,attributes:clipboardTitles},url:"index.php?route="+extension+"module/attributico/addAttributes",success:function(){reloadAttribute(b,!0)}});c.key.indexOf("category")+1&&$.ajax({data:{token:token,attributes:selNodes?getSelectedKeys(selNodes):[clipboardNodes[0][1].key],category_id:c.key,categories:selCategories?getSelectedKeys(selCategories):[c.key]},
url:"index.php?route="+extension+"module/attributico/addCategoryAttributes",success:function(){reactivateCategory(c)}})}function deleteAttributesFromCategory(b,c){var a=b.getParent().key;$.ajax({data:{token:token,attributes:selNodes?getSelectedKeys(selNodes):[b.key],category_id:a,categories:selCategories?getSelectedKeys(selCategories):[a]},url:"index.php?route="+extension+"module/attributico/deleteAttributesFromCategory",success:function(){reloadAttribute(b,!0)}});selNodes=null}
function addAttributeToCategory(b,c,a){$.ajax({data:{token:token,attributes:selNodes?getSelectedKeys(selNodes):[c.otherNode.key],category_id:b.key,categories:selCategories?getSelectedKeys(selCategories):[b.key]},url:"index.php?route="+extension+"module/attributico/addCategoryAttributes"}).done(function(){a?deleteAttributesFromCategory(c.otherNode,b):(deSelectNodes(c.otherNode),c.otherNode.tree.visit(function(a){a.isLazy()&&a.load(!0)}),reloadAttribute(c.otherNode,!1))})}
var clipboardNodes=[],clipboardTitles=[],pasteMode=null;
function copyPaste(b,c){switch(b){case "cut":case "copy":pasteMode=b;selNodes?selNodes.forEach(function(a,b){clipboardNodes[b]=[];clipboardTitles[b]=[];$attribute_group_tree.each(function(c,h){var g=$("#"+h.id).fancytree("getTree");clipboardNodes[b][c+1]=g.getNodeByKey(a.key);clipboardTitles[b][c+1]=g.getNodeByKey(a.key).title})}):(clipboardNodes[0]=[],clipboardTitles[0]=[],$attribute_group_tree.each(function(a,b){var f=$("#"+b.id).fancytree("getTree");clipboardNodes[0][a+1]=f.getNodeByKey(c.key);
clipboardTitles[0][a+1]=f.getNodeByKey(c.key).title}));break;case "paste":if(0==clipboardNodes.length){alert("Clipoard is empty.");break}"cut"==pasteMode?(copyAttributes(c,clipboardTitles),clipboardNodes[indx].remove()):copyAttributes(c,clipboardTitles);clipboardNodes=[];clipboardTitles=[];pasteMode=null;break;default:alert("Unhandled clipboard action '"+b+"'")}}
function initTrees(){$attribute_group_tree.each(function(b,c){var a=parseInt(c.id.replace(/\D+/ig,"")),d=$("#attribute_group_tree"+a),f=$('input[id = "sortOrder_attribute_group_tree'+a+'"]:checkbox').is(":checked");d.fancytree({autoCollapse:!0,autoScroll:!0,minExpandLevel:2,extensions:["edit","dnd","filter"],selectMode:2,checkbox:!1,quicksearch:!0,source:{data:{token:token,language_id:a,sortOrder:f,tree:"1",isPending:!1},url:"index.php?route="+extension+"module/attributico/getAttributeGroupTree"},
lazyLoad:function(b,e){e.result={data:{token:token,key:e.node.key,language_id:a},url:"index.php?route="+extension+"module/attributico/getLazyAttributeValues"}},edit:{triggerStart:["f2","shift+click","mac+enter"],inputCss:{minWidth:"18em"},beforeEdit:function(a,b){if(b.node.isRootNode()||1===b.node.getLevel()||4===b.node.getLevel())return!1},edit:function(a,b){},beforeClose:function(a,b){},save:function(b,e){var c=e.node.getParent();$.ajax({data:{token:token,key:e.node.key,name:e.input.val(),language_id:a,
oldname:e.orgTitle},url:"index.php?route="+extension+"module/attributico/editAttribute"}).done(function(a){e.node.key.indexOf("template")+1?c.getNextSibling().load(!0).done(function(a){reloadAttribute(e.node,!1)}):e.node.key.indexOf("value")+1?c.getPrevSibling().load(!0).done(function(a){c.load(!0).done(function(a){(e.node.tree.getNodeByKey(e.node.key)||e.node.getPrevSibling()||e.node.getNextSibling()).setActive()})}).done(function(a){reloadAttribute(e.node,!1)}):reloadAttribute(e.node,!1);e.node.setTitle(a.acceptedTitle)}).fail(function(a){e.node.setTitle(e.orgTitle)}).always(function(){$(e.node.span).removeClass("pending")});
return!0},close:function(a,b){b.save&&$(b.node.span).addClass("pending")}},dnd:{autoExpandMS:800,focusOnClick:!0,preventVoidMoves:!0,preventRecursiveMoves:!1,dragStart:function(a,b){return b.node.isRootNode()||3<b.node.getLevel()?!1:!0},dragEnter:function(a,b){var c=a.getLevel(),d=b.otherNode.getLevel(),g=b.otherNode;return 1===c||c>d||a===g.parent||a.parent===g.parent&&!b.tree.options.source.data.sortOrder?!1:c===d?["before","after"]:["over"]},dragDrop:function(a,b){var c=a.getLevel(),d=b.otherNode,
g=d.getLevel(),f=!1,h=d.getParent();selNodes?$.each(selNodes,function(c,d){d.moveTo(a,b.hitMode);f=!0}):d.moveTo(a,b.hitMode);a.getParent()!=h?(url="index.php?route="+extension+"module/attributico/replaceAttributeGroup",f=!1):url="index.php?route="+extension+"module/attributico/sortAttributeGroup";$.ajax({data:{token:token,attributes:selNodes?getSelectedKeys(selNodes):[d.key],group:c===g?a.getParent().key:a.key,target:a.key,direct:b.hitMode},url:url}).done(function(){reloadAttribute(d,f);deSelectNodes(d)})},
draggable:{scroll:!1}},beforeSelect:function(a,b){if(!selectControl(b))return!1},select:function(a,b){selNodes=b.tree.getSelectedNodes()},click:function(a,b){a.ctrlKey?b.node.toggleSelected():deSelectNodes(b.node)},keydown:function(b,e){var c=e.node;switch(b.which){case 66:b.ctrlKey&&(c.tree.visit(function(a){a.setExpanded(g)}),g=!g);break;case 46:deleteAttribute(c);break;case 77:b.ctrlKey&&addAttribute(c,"group",a);break;case 81:b.ctrlKey&&addAttribute(c,"attribute",a);break;case 67:if(b.ctrlKey)return copyPaste("copy",
c),!1;break;case 86:if(b.ctrlKey)return copyPaste("paste",c),deSelectNodes(c),!1}},filter:{autoApply:!0,counter:!0,fuzzy:!1,hideExpandedCounter:!0,highlight:!0,mode:"dimm"}});var h=d.fancytree("getTree"),g=!0;$("input[name=tab-attribute_search"+a+"]").keyup({tree:h,tab:"tab-attribute",lng_id:a},FilterSearch).focus();$("button#tab-attribute_btnSearch"+a).click({tree:h,tab:"tab-attribute",lng_id:a},FilterButtonSearch);$("div#tab-attribute_filter"+a+" input:checkbox").change({tree:h,tab:"tab-attribute",
lng_id:a},FilterSettingsChange);$("button#tab-attribute_btnResetSearch"+a).click(function(b){ClearFilter(h,"tab-attribute",a)}).attr("disabled",!0);$("button#tab-attribute_btnSearch"+a).attr("disabled",$("input#tab-attribute_autoComplete"+a).is(":checked"));d.contextmenu({delegate:"span.fancytree-title",menu:contextmenu[a],beforeOpen:function(a,b){var c=$.ui.fancytree.getNode(b.target);d.contextmenu("enableEntry","copy",!c.key.indexOf("attribute"));d.contextmenu("enableEntry","paste",0!=clipboardNodes.length&&
!c.getParent().isRootNode());c.setActive()},select:function(b,e){var c=$.ui.fancytree.getNode(e.target);switch(e.cmd){case "expande":h.visit(function(a){a.setExpanded(!0)});g=!g;break;case "collapse":h.visit(function(a){a.setExpanded(!1)});g=!g;break;case "options":$("#options_attribute_group_tree"+a).dialog("open");break;case "rename":c.editStart();break;case "remove":deleteAttribute(c);break;case "addChild":1!==c.getLevel()&&addAttribute(c,"attribute",a);break;case "addSibling":addAttribute(c,"group",
a);break;case "copy":copyPaste(e.cmd,c);break;case "paste":copyPaste(e.cmd,c);deSelectNodes(c);break;default:alert("Todo: appply action '"+e.cmd+"' to node "+c)}}})});$category_tree.each(function(b,c){var a=parseInt(c.id.replace(/\D+/ig,"")),d=$("#category_tree"+a),f=!0,h=$('input[id = "sortOrder_category_tree'+a+'"]:checkbox').is(":checked");d.fancytree({autoCollapse:!0,autoScroll:!0,minExpandLevel:2,extensions:["dnd"],checkbox:!0,selectMode:$('input[id = "multiSelect_category_tree'+a+'"]:checkbox').is(":checked")?
3:2,source:{data:{token:token,language_id:a,sortOrder:h},url:"index.php?route="+extension+"module/attributico/getCategoryTree"},activate:function(b,c){var e=$("#category_attribute_tree"+a).fancytree("getTree");currentCategory=c.node.key;e.reload({data:{token:token,language_id:a,category_id:currentCategory,sortOrder:$('input[id = "sortOrder_category_attribute_tree'+a+'"]:checkbox').is(":checked"),tree:"4"},url:"index.php?route="+extension+"module/attributico/getCategoryAttributeTree"})},dnd:{autoExpandMS:400,
focusOnClick:!1,preventVoidMoves:!0,preventRecursiveMoves:!0,dragStart:function(a,b){return!1},dragEnter:function(a,b){return b.otherNode.getParent().key===a.key?!1:!0},dragDrop:function(a,b){addAttributeToCategory(a,b,b.otherNode.tree.$div.context.id.indexOf("attribute_tree"))}},select:function(a,b){selCategories=b.tree.getSelectedNodes();b.tree.options.autoCollapse=!1;b.node.setExpanded(!(b.node.expanded&&!selCategories.length))},keydown:function(a,b){var e=b.node;switch(a.which){case 66:a.ctrlKey&&
(e.tree.visit(function(a){a.setExpanded(f)}),f=!f);break;case 86:if(a.ctrlKey)return copyPaste("paste",e),deSelectNodes(e),!1}},focusTree:function(a,b){b.tree.$container.focus()}});d.contextmenu({delegate:"span.fancytree-title",menu:contextmenu[a],beforeOpen:function(a,b){var e=$.ui.fancytree.getNode(b.target);d.contextmenu("enableEntry","remove",!1);d.contextmenu("enableEntry","rename",!1);d.contextmenu("enableEntry","addSibling",!1);d.contextmenu("enableEntry","addChild",!1);d.contextmenu("enableEntry",
"paste",0!=clipboardNodes.length&&!e.getParent().isRootNode());e.setActive()},select:function(b,c){var e=$.ui.fancytree.getNode(c.target);switch(c.cmd){case "expande":d.fancytree("getTree").visit(function(a){a.setExpanded(!0)});break;case "collapse":d.fancytree("getTree").visit(function(a){a.setExpanded(!1)});break;case "options":$("#options_category_tree"+a).dialog("open");break;case "paste":copyPaste(c.cmd,e);deSelectNodes(e);break;default:alert("Todo: appply action '"+c.cmd+"' to node "+e)}}})});
$category_attribute_tree.each(function(b,c){var a=parseInt(c.id.replace(/\D+/ig,"")),d=$("#category_attribute_tree"+a),f=!0,h=$('input[id = "sortOrder_category_attribute_tree'+a+'"]:checkbox').is(":checked");d.fancytree({autoCollapse:!0,autoScroll:!0,minExpandLevel:2,selectMode:2,extensions:["edit","dnd"],source:{data:{token:token,language_id:a,category_id:currentCategory,sortOrder:h,tree:"4"},url:"index.php?route="+extension+"module/attributico/getCategoryAttributeTree"},lazyLoad:function(b,c){c.result=
{data:{token:token,key:c.node.key,language_id:a},url:"index.php?route="+extension+"module/attributico/getLazyAttributeValues"}},edit:{triggerStart:[],inputCss:{minWidth:"18em"},beforeEdit:function(a,b){if(!b.isNew)return!1},edit:function(b,c){c.input.dropmenu({source:function(b,c){$.ajax({data:{token:token,filter_name:encodeURIComponent(b),language_id:a},url:"index.php?route="+extension+"module/attributico/autocomplete",dataType:"json",success:function(a){c($.map(a,function(a){return{category:a.attribute_group,
label:a.name,value:a.attribute_id}}))}})},select:function(a){c.input.val(a.label);c.node.key="attribute_"+a.value}})},beforeClose:function(a,b){},save:function(a,b){$.ajax({data:{token:token,attributes:[b.node.key],category_id:b.node.getParent().key,categories:selCategories?getSelectedKeys(selCategories):[b.node.getParent().key]},url:"index.php?route="+extension+"module/attributico/addCategoryAttributes"}).done(function(){$(b.node.span).removeClass("pending");b.node.setTitle(b.node.title);reactivateCategory(b.node.getParent())});
return!0},close:function(a,b){b.save&&$(b.node.span).addClass("pending")}},dnd:{autoExpandMS:400,focusOnClick:!1,preventVoidMoves:!0,preventRecursiveMoves:!0,dragStart:function(a,b){return!0},dragEnter:function(a,b){return a.tree===b.otherNode.tree||2<a.getLevel()?!1:!0},dragDrop:function(a,b){addAttributeToCategory(a.getParent().isRootNode()?a:a.getParent(),b,!1)}},beforeSelect:function(a,b){if(!selectControl(b))return!1},select:function(a,b){selNodes=b.tree.getSelectedNodes()},click:function(a,
b){a.ctrlKey?b.node.toggleSelected():deSelectNodes(b.node)},keydown:function(a,b){var e=b.node;switch(a.which){case 66:a.ctrlKey&&(e.tree.visit(function(a){a.setExpanded(f)}),f=!f);break;case 46:deleteAttributesFromCategory(e,e);break;case 81:a.ctrlKey&&e.tree.getRootNode().getFirstChild().editCreateNode("child");break;case 67:if(a.ctrlKey)return copyPaste("copy",e),!1;break;case 86:if(a.ctrlKey)return copyPaste("paste",e),deSelectNodes(e),!1}},focusTree:function(a,b){b.tree.$container.focus()}});
d.contextmenu({delegate:"span.fancytree-title",menu:contextmenu[a],beforeOpen:function(a,b){var e=$.ui.fancytree.getNode(b.target);d.contextmenu("enableEntry","remove",!e.key.indexOf("attribute"));d.contextmenu("enableEntry","rename",!1);d.contextmenu("enableEntry","addSibling",!1);d.contextmenu("enableEntry","copy",!e.key.indexOf("attribute"));d.contextmenu("enableEntry","paste",0!=clipboardNodes.length);e.setActive()},select:function(b,c){var e=$.ui.fancytree.getNode(c.target);switch(c.cmd){case "expande":d.fancytree("getTree").visit(function(a){a.setExpanded(!0)});
break;case "collapse":d.fancytree("getTree").visit(function(a){a.setExpanded(!1)});break;case "remove":deleteAttributesFromCategory(e,e);break;case "addChild":e.tree.getRootNode().getFirstChild().editCreateNode("child");break;case "options":$("#options_category_attribute_tree"+a).dialog("open");break;case "copy":copyPaste(c.cmd,e);break;case "paste":copyPaste(c.cmd,e);deSelectNodes(e);break;default:alert("Todo: appply action '"+c.cmd+"' to node "+e)}}})});$attribute_tree.each(function(b,c){var a=
parseInt(c.id.replace(/\D+/ig,"")),d=$("#attribute_tree"+a),f=!0,h=$('input[id = "sortOrder_attribute_tree'+a+'"]:checkbox').is(":checked");d.fancytree({autoCollapse:!0,autoScroll:!0,minExpandLevel:2,extensions:["dnd","filter"],selectMode:2,checkbox:!1,quicksearch:!0,source:{data:{token:token,language_id:a,sortOrder:h,isPending:!1,tree:"3"},url:"index.php?route="+extension+"module/attributico/getAttributeGroupTree"},lazyLoad:function(b,c){c.result={data:{token:token,key:c.node.key,language_id:a},
url:"index.php?route="+extension+"module/attributico/getLazyAttributeValues"}},dnd:{autoExpandMS:800,focusOnClick:!0,preventVoidMoves:!0,preventRecursiveMoves:!0,dragStart:function(a,b){return 3!==b.node.getLevel()?!1:!0},draggable:{revert:!0,cursorAt:{top:-5,left:-5},connectToFancytree:!0,appendTo:"body",scroll:!0}},beforeSelect:function(a,b){if(!selectControl(b))return!1},select:function(a,b){selNodes=b.tree.getSelectedNodes()},click:function(a,b){a.ctrlKey?b.node.toggleSelected():deSelectNodes(b.node)},
keydown:function(a,b){var c=b.node;switch(a.which){case 66:a.ctrlKey&&(c.tree.visit(function(a){a.setExpanded(f)}),f=!f);break;case 67:if(a.ctrlKey)return copyPaste("copy",c),!1}},filter:{autoApply:!0,counter:!0,fuzzy:!1,hideExpandedCounter:!0,highlight:!0,mode:"dimm"}});var g=d.fancytree("getTree");$("input[name=tab-category_search"+a+"]").keyup({tree:g,tab:"tab-category",lng_id:a},FilterSearch).focus();$("button#tab-category_btnSearch"+a).click({tree:g,tab:"tab-category",lng_id:a},FilterButtonSearch);
$("div#tab-category_filter"+a+" input:checkbox").change({tree:g,tab:"tab-category",lng_id:a},FilterSettingsChange);$("button#tab-category_btnResetSearch"+a).click(function(b){ClearFilter(g,"tab-category",a)}).attr("disabled",!0);$("button#tab-category_btnSearch"+a).attr("disabled",$("input#tab-category_autoComplete"+a).is(":checked"));d.contextmenu({delegate:"span.fancytree-title",menu:contextmenu[a],beforeOpen:function(a,b){var c=$.ui.fancytree.getNode(b.target);d.contextmenu("enableEntry","remove",
!1);d.contextmenu("enableEntry","rename",!1);d.contextmenu("enableEntry","addSibling",!1);d.contextmenu("enableEntry","addChild",!1);d.contextmenu("enableEntry","copy",!c.key.indexOf("attribute"));c.setActive()},select:function(b,c){var g=$.ui.fancytree.getNode(c.target);switch(c.cmd){case "expande":d.fancytree("getTree").visit(function(a){a.setExpanded(!0)});break;case "collapse":d.fancytree("getTree").visit(function(a){a.setExpanded(!1)});break;case "options":$("#options_attribute_tree"+a).dialog("open");
break;case "copy":copyPaste(c.cmd,g);break;default:alert("Todo: appply action '"+c.cmd+"' to node "+g)}}})});$duty_attribute_tree.each(function(b,c){var a=parseInt(c.id.replace(/\D+/ig,"")),d=$("#duty_attribute_tree"+a),f=$('input[id = "sortOrder_duty_attribute_tree'+a+'"]:checkbox').is(":checked");d.fancytree({autoCollapse:!0,autoScroll:!0,minExpandLevel:2,extensions:["edit","filter"],checkbox:!1,quicksearch:!0,source:{data:{token:token,language_id:a,sortOrder:f,isPending:!1,tree:"2"},url:"index.php?route="+
extension+"module/attributico/getAttributeGroupTree"},lazyLoad:function(b,c){c.result={data:{token:token,key:c.node.key,language_id:a},url:"index.php?route="+extension+"module/attributico/getLazyAttributeValues"}},edit:{triggerStart:["f2","shift+click","mac+enter"],inputCss:{minWidth:"18em"},beforeEdit:function(a,b){if(b.node.isRootNode()||1===b.node.getLevel())return!1},save:function(b,c){var d=c.node.getParent();$.ajax({data:{token:token,key:c.node.key,name:c.input.val(),language_id:a,oldname:c.orgTitle},
url:"index.php?route="+extension+"module/attributico/editAttribute"}).done(function(a){c.node.key.indexOf("template")+1?d.getNextSibling().load(!0).done(function(a){reloadAttribute(c.node,!1)}):c.node.key.indexOf("value")+1?d.getPrevSibling().load(!0).done(function(a){d.load(!0).done(function(a){(c.node.tree.getNodeByKey(c.node.key)||c.node.getPrevSibling()||c.node.getNextSibling()).setActive()})}).done(function(a){reloadAttribute(c.node,!1)}):reloadAttribute(c.node,!1);c.node.setTitle(a.acceptedTitle)}).fail(function(a){c.node.setTitle(c.orgTitle)}).always(function(){$(c.node.span).removeClass("pending")});
return!0},close:function(a,b){b.save&&$(b.node.span).addClass("pending")}},beforeSelect:function(a,b){return!1},keydown:function(a,b){var c=b.node;switch(a.which){case 66:a.ctrlKey&&(c.tree.visit(function(a){a.setExpanded(g)}),g=!g)}},filter:{autoApply:!0,counter:!0,fuzzy:!1,hideExpandedCounter:!0,highlight:!0,mode:"dimm"}});var h=d.fancytree("getTree"),g=!0;$("input[name=tab-duty_search"+a+"]").keyup({tree:h,tab:"tab-duty",lng_id:a},FilterSearch).focus();$("button#tab-duty_btnSearch"+a).click({tree:h,
tab:"tab-duty",lng_id:a},FilterButtonSearch);$("div#tab-duty_filter"+a+" input:checkbox").change({tree:h,tab:"tab-duty",lng_id:a},FilterSettingsChange);$("button#tab-duty_btnResetSearch"+a).click(function(b){ClearFilter(h,"tab-duty",a)}).attr("disabled",!0);$("button#tab-duty_btnSearch"+a).attr("disabled",$("input#tab-duty_autoComplete"+a).is(":checked"));d.contextmenu({delegate:"span.fancytree-title",menu:contextmenu[a],beforeOpen:function(a,b){var c=$.ui.fancytree.getNode(b.target);d.contextmenu("enableEntry",
"remove",!1);d.contextmenu("enableEntry","addSibling",!1);d.contextmenu("enableEntry","addChild",!1);c.setActive()},select:function(b,c){var d=$.ui.fancytree.getNode(c.target);switch(c.cmd){case "expande":h.visit(function(a){a.setExpanded(!0)});g=!g;break;case "collapse":h.visit(function(a){a.setExpanded(!1)});g=!g;break;case "options":$("#options_duty_attribute_tree"+a).dialog("open");break;case "rename":d.editStart();break;default:alert("Todo: appply action '"+c.cmd+"' to node "+d)}}})});$attribute_product_tree.each(function(b,
c){var a=parseInt(c.id.replace(/\D+/ig,"")),d=$("#attribute_product_tree"+a),f=!0,h=$('input[id = "sortOrder_attribute_product_tree'+a+'"]:checkbox').is(":checked");d.fancytree({autoCollapse:!0,autoScroll:!0,minExpandLevel:2,extensions:["dnd","filter"],selectMode:2,checkbox:!1,quicksearch:!0,source:{data:{token:token,language_id:a,sortOrder:h,isPending:!1,tree:"5"},url:"index.php?route="+extension+"module/attributico/getAttributeGroupTree"},beforeActivate:function(a,b){},activate:function(b,c){var d=
$("#product_tree"+a).fancytree("getTree");currentAttributeID=c.node.key;d.reload({data:{token:token,language_id:a,attribute_id:currentAttributeID,title:c.node.title,sortOrder:$('input[id = "sortOrder_product_tree'+a+'"]:checkbox').is(":checked"),tree:"4"},url:"index.php?route="+extension+"module/attributico/getProductTree"})},lazyLoad:function(b,c){c.result={data:{token:token,key:c.node.key,language_id:a},url:"index.php?route="+extension+"module/attributico/getLazyAttributeValues"}},dnd:{autoExpandMS:800,
focusOnClick:!0,preventVoidMoves:!0,preventRecursiveMoves:!0,dragStart:function(a,b){return 3!==b.node.getLevel()?!1:!0},draggable:{revert:!0,cursorAt:{top:-5,left:-5},connectToFancytree:!0,appendTo:"body",scroll:!0}},beforeSelect:function(a,b){if(!selectControl(b))return!1},select:function(a,b){selNodes=b.tree.getSelectedNodes()},click:function(a,b){a.ctrlKey?b.node.toggleSelected():deSelectNodes(b.node)},keydown:function(a,b){var c=b.node;switch(a.which){case 66:a.ctrlKey&&(c.tree.visit(function(a){a.setExpanded(f)}),
f=!f);break;case 67:if(a.ctrlKey)return copyPaste("copy",c),!1}},filter:{autoApply:!0,counter:!0,fuzzy:!1,hideExpandedCounter:!0,highlight:!0,mode:"dimm"}});var g=d.fancytree("getTree");$("input[name=tab-products_search"+a+"]").keyup({tree:g,tab:"tab-products",lng_id:a},FilterSearch).focus();$("button#tab-products_btnSearch"+a).click({tree:g,tab:"tab-products",lng_id:a},FilterButtonSearch);$("div#tab-products_filter"+a+" input:checkbox").change({tree:g,tab:"tab-products",lng_id:a},FilterSettingsChange);
$("button#tab-products_btnResetSearch"+a).click(function(b){ClearFilter(g,"tab-products",a)}).attr("disabled",!0);$("button#tab-products_btnSearch"+a).attr("disabled",$("input#tab-products_autoComplete"+a).is(":checked"));d.contextmenu({delegate:"span.fancytree-title",menu:contextmenu[a],beforeOpen:function(a,b){var c=$.ui.fancytree.getNode(b.target);d.contextmenu("enableEntry","remove",!1);d.contextmenu("enableEntry","rename",!1);d.contextmenu("enableEntry","addSibling",!1);d.contextmenu("enableEntry",
"addChild",!1);d.contextmenu("enableEntry","copy",!c.key.indexOf("attribute"));c.setActive()},select:function(b,c){var g=$.ui.fancytree.getNode(c.target);switch(c.cmd){case "expande":d.fancytree("getTree").visit(function(a){a.setExpanded(!0)});break;case "collapse":d.fancytree("getTree").visit(function(a){a.setExpanded(!1)});break;case "options":$("#options_attribute_product_tree"+a).dialog("open");break;case "copy":copyPaste(c.cmd,g);break;default:alert("Todo: appply action '"+c.cmd+"' to node "+
g)}}})});$product_tree.each(function(b,c){var a=parseInt(c.id.replace(/\D+/ig,"")),d=$("#product_tree"+a),f=!0,h=$('input[id = "sortOrder_product_tree'+a+'"]:checkbox').is(":checked");d.fancytree({autoCollapse:!0,autoScroll:!0,minExpandLevel:2,selectMode:2,extensions:["edit","dnd"],source:{data:{token:token,language_id:a,attribute_id:currentAttributeID,sortOrder:h,tree:"4"},url:"index.php?route="+extension+"module/attributico/getProductTree"},edit:{},dnd:{autoExpandMS:400,focusOnClick:!1,preventVoidMoves:!0,
preventRecursiveMoves:!0,dragStart:function(a,b){return!0},dragEnter:function(a,b){return a.tree===b.otherNode.tree||2<a.getLevel()?!1:!0},dragDrop:function(a,b){addAttributeToCategory(a.getParent().isRootNode()?a:a.getParent(),b,!1)}},beforeSelect:function(a,b){if(!selectControl(b))return!1},select:function(a,b){selNodes=b.tree.getSelectedNodes()},dblclick:function(a,b){location.href="index.php?route=catalog/product/edit&token="+token+"&product_id="+b.node.key.split("_")[1]},click:function(a,b){a.ctrlKey?
b.node.toggleSelected():deSelectNodes(b.node)},keydown:function(a,b){var c=b.node;switch(a.which){case 66:a.ctrlKey&&(c.tree.visit(function(a){a.setExpanded(f)}),f=!f);break;case 86:if(a.ctrlKey)return copyPaste("paste",c),deSelectNodes(c),!1}},focusTree:function(a,b){b.tree.$container.focus()}});d.contextmenu({delegate:"span.fancytree-title",menu:contextmenu[a],beforeOpen:function(a,b){var c=$.ui.fancytree.getNode(b.target);d.contextmenu("enableEntry","remove",!c.key.indexOf("attribute"));d.contextmenu("enableEntry",
"rename",!1);d.contextmenu("enableEntry","addSibling",!1);d.contextmenu("enableEntry","copy",!c.key.indexOf("attribute"));d.contextmenu("enableEntry","paste",0!=clipboardNodes.length);c.setActive()},select:function(b,c){var e=$.ui.fancytree.getNode(c.target);switch(c.cmd){case "expande":d.fancytree("getTree").visit(function(a){a.setExpanded(!0)});break;case "collapse":d.fancytree("getTree").visit(function(a){a.setExpanded(!1)});break;case "options":$("#options_product_tree"+a).dialog("open");break;
case "paste":copyPaste(c.cmd,e);deSelectNodes(e);break;default:alert("Todo: appply action '"+c.cmd+"' to node "+e)}}})})}
(function(b){b.fn.dropmenu=function(c){return this.each(function(){this.timer=null;this.items=[];$div=b("<div />");$menu=$ul=b("<ul class='drop-menu' />");b.extend(this,c);b(this).attr("autocomplete","off");b(this).on("focus",function(a){a.preventDefault();this.request()});b(this).on("blur",function(){setTimeout(function(a){a.hide()},200,this)});b(this).on("keydown",function(a){a.preventDefault();switch(a.keyCode){case 27:this.hide();break;default:this.request()}});b(this).on("mousedown",function(a){a.preventDefault();
a.stopPropagation();b(this).focus()});this.click=function(a){a.preventDefault();(value=b(a.target).parent().attr("data-value"))&&this.items[value]&&this.select(this.items[value])};this.show=function(){var a=b(this).position();b(this).siblings("div").children($menu).css({top:a.top+b(this).outerHeight(),left:a.left});b(this).siblings("div").children($menu).show()};this.hide=function(){b(this).siblings("div").children($menu).hide()};this.request=function(){clearTimeout(this.timer);this.timer=setTimeout(function(a){a.source(b(a).val(),
b.proxy(a.response,a))},200,this)};this.response=function(a){html="";if(a.length){for(i=0;i<a.length;i++)this.items[a[i].value]=a[i];for(i=0;i<a.length;i++)a[i].category||(html+='<li data-value="'+a[i].value+'"><a href="#">'+a[i].label+"</a></li>");var c=[];for(i=0;i<a.length;i++)a[i].category&&(c[a[i].category]||(c[a[i].category]=[],c[a[i].category].name=a[i].category,c[a[i].category].item=[]),c[a[i].category].item.push(a[i]));for(i in c)for(html+='<li class="drop-header">'+c[i].name+"</li>",j=0;j<
c[i].item.length;j++)html+='<li data-value="'+c[i].item[j].value+'"><a href="#">&nbsp;&nbsp;&nbsp;'+c[i].item[j].label+"</a></li>"}html?this.show():this.hide();b(this).siblings("div").children($menu).html(html)};b(this).after($div);$menu.appendTo($div);b(this).siblings("div").children($menu).delegate("a","mousedown",b.proxy(this.click,this))})}})(window.jQuery);
function dutyUpgrade(){$.ajax({data:{token:token},url:"index.php?route="+extension+"module/attributico/dutyUpgrade",success:function(){location.reload()}})}
function apply(){$('[id ^= "tree"]').each(function(b,c){$(c).fancytree("getTree").generateFormElements()});$(".alert-success, .alert-danger").hide();$.post($("#form-attributico").attr("action"),$("#form-attributico").serialize(),function(b){var c=$(b).find(".alert-success, .alert-danger");0<c.length?$(".alert-before").before(c):(b=$(b).find('[selected="selected"]').val(),$.post(b,"",function(a){a=$(a).find(".alert-success, .alert-danger");0<a.length&&$(".alert-before").before(a)}));$('input[id ^= "multiSelect"]:checkbox').prop("checked",
$('input[name = "attributico_multiselect"]:checkbox').is(":checked"));$('input[id ^= "sortOrder"]:checkbox').prop("checked",$('input[name = "attributico_sortorder"]:checkbox').is(":checked"));$category_tree.each(function(a,b){$("#"+b.id).fancytree("getTree").options.selectMode=$('input[id ^= "multiSelect"]:checkbox').is(":checked")?3:2});$attribute_trees.each(function(a,b){var c=$("#"+b.id).fancytree("getTree");c.options.source.data.sortOrder=$('input[id ^= "sortOrder"]:checkbox').is(":checked");
c.options.source.data.category_id=currentCategory;c.reload()})})}
$(function(){$('[id ^= "tree"]').each(function(b,c){$(c).fancytree({checkbox:!0,selectMode:2,source:{data:{token:token,tree:b+1},url:"index.php?route="+extension+"module/attributico/getChildrenSettings"}})});$("#form-attributico").submit(function(){$('[id ^= "tree"]').each(function(b,c){$(c).fancytree("getTree").generateFormElements()})});$("#e1").on("click",function(b){b=$(b.relatedTarget).text();alert("Нажмите на OK для просмотра выпадающего меню для пункта: "+b);return!1});$('a[data-toggle="pill"]').on("shown.bs.tab",
function(b){$("#column-2 .alert-success").hide();$("#column-2 .alert-info").show()});$("#vtabs2").bind("tabsselect",function(b,c){alert("select");$("#column-2 .alert-success").hide();$("#column-2 .alert-info").show()})});
function FilterAction(b,c,a){$("span#"+a+"_searchmode"+c+" input#"+a+"_regex"+c+":checkbox").prop({checked:!0});switch($(b).attr("id")){case "f_"+a+"_empty":$("input[name="+a+"_search"+c+"]").val("^s*$");$("button#"+a+"_btnSearch"+c).trigger("click");break;case "f_"+a+"_digital":$("input[name="+a+"_search"+c+"]").val("[0-9]");$("button#"+a+"_btnSearch"+c).trigger("click");break;case "f_"+a+"_html":$("input[name="+a+"_search"+c+"]").val("<[^>]+>");$("button#"+a+"_btnSearch"+c).trigger("click");break;
case "f_"+a+"_default":$("span#"+a+"_searchmode"+c+" input#"+a+"_regex"+c+":checkbox").prop({checked:!1}),$("button#"+a+"_btnResetSearch"+c).trigger("click")}return!1}
function tools(b){$.ajax({data:{token:token,task:b},url:"index.php?route="+extension+"module/attributico/tools",beforeSend:function(){$("#column-2 .loader-img").show();$("#column-2 .alert-success").hide();$("#column-2 .alert-warning").show()},success:function(b){reloadAttribute();$("#column-2 .loader-img").hide();$("#column-2 .alert-warning").hide();$("#column-2 .alert-success").show()}})};
